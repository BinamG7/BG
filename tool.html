<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TGF — Data Analysis Terminal (BG Tool)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://kit.fontawesome.com/a2e860f6c5.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: Consolas, monospace; background:#000; color:#ffb347; }
    header { padding:20px; background:#111; border-bottom:2px solid #ffb347; display:flex; gap:20px; align-items:center; }
    h1{margin:0}
    .subtitle{color:#ffdd99;font-size:14px}
    .muted{color:#d9c089;font-size:11px}
    .container{padding:20px}
    .panel{background:#111;border:1px solid #ffb34733;border-radius:8px;padding:12px;margin-bottom:18px}
    button{background:#ffb347;color:#000;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:bold}
    button:hover{background:#ff9500}
    label{font-size:14px;color:#ffdd99}
    select,input{background:#000;border:1px solid #ffb34766;color:#ffdd99;padding:6px;border-radius:6px;margin-top:5px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ffb34733;padding:6px;font-size:13px;color:#ffdd99}
    th{background:#1a1a1a}
    .chart-area{background:#111;border:1px solid #ffb34733;padding:10px;border-radius:10px;margin-top:15px}

    /* advanced preview */
    #previewContainer {
      max-height: 360px; /* keeps overall layout stable */
      overflow: auto;
      border: 1px solid rgba(255,179,71,0.12);
      padding: 6px;
      border-radius: 6px;
      background: #070707;
    }
    #previewTools{display:flex;gap:8px;align-items:center;margin-top:8px}
    #paginationControls { margin-left:8px; display:flex; gap:8px; align-items:center }
    #pageInfo{color:#ffdd99}
    .small{font-size:12px;color:#d9c089}
    .rows-per-page{width:70px}
  </style>
</head>
<body>
<header>
  <h1>[TGF Data Analysis Terminal]</h1>
  <div style="display:flex;flex-direction:column">
    <div class="subtitle">Resource Analytics Suite — local, offline</div>
    <div class="muted">Load CSV → Inspect → Detect → Flag → Export</div>
  </div>
</header>
<div style="width:100%;text-align:center;padding:10px 0;background:rgba(255,179,71,0.10);color:#ffb347;font-size:14px;border-bottom:1px solid rgba(255,179,71,0.2)">⚠️ On mobile → enable Desktop View.</div>
<div class="container">

  <div class="panel">
    <label>Select CSV file:</label><br />
    <input type="file" id="csvFile" accept=".csv" />
    <button onclick="loadCSV()">Load</button>
    <div style="margin-top:10px;">
      <label>Delimiter:</label>
      <select id="delimiter">
        <option value=",">Comma (,)</option>
        <option value=";">Semicolon (;)</option>
        <option value="	">Tab</option>
      </select>
    </div>
  </div>

  <div class="panel">
    <h3>Preview</h3>
    <!-- advanced preview area: scrollable with pagination and full-preview toggle -->
    <div id="previewContainer"><div id="preview"></div></div>
    <div id="previewTools">
      <div id="paginationControls">
        <button onclick="prevPage()">◀ Prev</button>
        <span id="pageInfo"></span>
        <button onclick="nextPage()">Next ▶</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label class="small">Rows / page</label>
        <select id="rowsPerPage" class="rows-per-page" onchange="changeRowsPerPage()">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <button onclick="showFullPreview()">Show Full</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <h3>Descriptive Statistics</h3>
    <label>Select Column:</label>
    <select id="statsColumn"></select>
    <button onclick="showStats()">Run</button>
    <div id="statsOutput" style="margin-top:12px;"></div>
  </div>

  <div class="panel">
    <h3>Anomaly Detection</h3>
    <label>Column:</label>
    <select id="anomalyColumn"></select>
    <label>Method:</label>
    <select id="anomalyMethod">
      <option value="iqr">IQR</option>
      <option value="zscore">Z-score</option>
    </select>
    <button onclick="detectAnomalies()">Detect</button>
    <button onclick="exportAnomalies()">Export Anomalies</button>
    <div id="anomalyOutput" style="margin-top:12px;"></div>
  </div>

  <div class="panel">
    <h3>Categorical Values</h3>
    <label>Select Column:</label>
    <select id="catColumn"></select>
    <button onclick="categoricalSummary()">Show</button>
    <div id="catOutput" style="margin-top:12px;"></div>
  </div>

  <div class="panel">
    <h3>Filter Data</h3>
    <label>Column:</label>
    <select id="filterColumn"></select>
    <label>Condition:</label>
    <select id="filterCondition">
      <option value="==">=</option>
      <option value="!=">≠</option>
      <option value=">">&gt;</option>
      <option value="<">&lt;</option>
      <option value=">=">&gt;=</option>
      <option value="<=">&lt;=</option>
      <option value="contains">contains</option>
    </select>
    <input type="text" id="filterValue" placeholder="Value..." />
    <button onclick="applyFilter()">Apply</button>
    <div id="filterOutput" style="margin-top:12px;"></div>
  </div>

  <div class="panel">
    <h3>Group & Aggregate</h3>
    <label>Group by:</label>
    <select id="groupBy1"></select>
    <label>Aggregate target:</label>
    <select id="groupAggCol"></select>
    <label>Function:</label>
    <select id="groupFunction">
      <option value="sum">Sum</option>
      <option value="mean">Average</option>
      <option value="count">Count</option>
    </select>
    <button onclick="runGroup()">Run</button>
    <div id="groupOutput" style="margin-top:12px;"></div>
  </div>

  <!-- NEW DATE-TIME ANALYSIS PANEL -->
  <div class="panel">
    <h3>Date & Time Analysis</h3>
    <label>Select Date Column:</label>
    <select id="dateColumn"></select>

    <label style="margin-top:10px">Operation:</label>
    <select id="dateOperation">
      <option value="minmax">Min & Max Date</option>
      <option value="count_per_day">Count per Day</option>
      <option value="count_per_month">Count per Month</option>
      <option value="count_per_year">Count per Year</option>
    </select>

    <button onclick="runDateAnalysis()">Run</button>

    <div id="dateOutput" style="margin-top:12px"></div>
  </div>

  <div class="panel">
    <h3>Charts</h3>
    <label>Chart Type:</label>
    <select id="chartType">
      <option value="bar">Bar</option>
      <option value="line">Line</option>
    </select>
    <label>X-Axis:</label>
    <select id="chartX"></select>
    <label>Y-Axis:</label>
    <select id="chartY"></select>
    <button onclick="drawChart()">Draw</button>
    <div class="chart-area"><canvas id="myChart"></canvas></div>
  </div>
</div>

<script>
let DATA=[]; let HEADERS=[]; let ANOMALIES=[]; let chartInstance=null;
let currentPage=1; let rowsPerPage=20; let showingFull=false;

function loadCSV(){
  let file=document.getElementById("csvFile").files[0];
  let delimiter=document.getElementById("delimiter").value;
  if(!file){ alert('Please choose a CSV file.'); return; }
  Papa.parse(file,{delimiter,header:true,skipEmptyLines:true,complete:(res)=>{
      DATA=res.data; HEADERS=res.meta.fields || Object.keys(DATA[0] || {});
      ANOMALIES=[]; chartInstance=null; showingFull=false;
      rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 20;
      currentPage=1;
      populateSelectors(); renderPage();
  }});
}

function renderPage(){
  if(showingFull){ previewTable(DATA); document.getElementById('pageInfo').innerText = `FULL (${DATA.length} rows)`; return; }
  if(!DATA.length){ document.getElementById('preview').innerHTML='No data loaded.'; document.getElementById('pageInfo').innerText=''; return; }
  let totalPages = Math.max(1, Math.ceil(DATA.length/rowsPerPage));
  if(currentPage > totalPages) currentPage = totalPages;
  let start=(currentPage-1)*rowsPerPage; let end=Math.min(start+rowsPerPage, DATA.length);
  previewTable(DATA.slice(start,end));
  document.getElementById('pageInfo').innerText = `Page ${currentPage} / ${totalPages} (${start+1}-${end} of ${DATA.length})`;
}

function nextPage(){ if(showingFull) return; let totalPages=Math.ceil(DATA.length/rowsPerPage); if(currentPage<totalPages){ currentPage++; renderPage(); } }
function prevPage(){ if(showingFull) return; if(currentPage>1){ currentPage--; renderPage(); } }
function showFullPreview(){ showingFull=true; previewTable(DATA); document.getElementById('pageInfo').innerText = `FULL (${DATA.length} rows)`; }
function changeRowsPerPage(){ rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 20; currentPage=1; showingFull=false; renderPage(); }

function previewTable(rows){
  if(!HEADERS || !HEADERS.length){ document.getElementById('preview').innerHTML='No headers available.'; return; }
  let html="<table><tr>";
  HEADERS.forEach(h=>html+=`<th>${h}</th>`); html+="</tr>";
  rows.forEach(r=>{ html+="<tr>"; HEADERS.forEach(h=>{ let v = (r && (r[h]!==undefined && r[h]!==null))? r[h] : ''; html+=`<td>${escapeHtml(String(v))}</td>`; }); html+="</tr>"; });
  html+="</table>";
  document.getElementById('preview').innerHTML=html;
}

function populateSelectors(){
  let ids=["statsColumn","anomalyColumn","catColumn","filterColumn","groupBy1","groupAggCol","chartX","chartY","dateColumn"];
  ids.forEach(id=>{
    let s=document.getElementById(id); if(!s) return; s.innerHTML='';
    HEADERS.forEach(h=>s.innerHTML+=`<option value="${h}">${h}</option>`);
  });
}

function showStats(){
  let col=document.getElementById("statsColumn").value;
  let nums=DATA.map(r=>parseFloat(r[col])).filter(v=>!isNaN(v));
  if(!nums.length){document.getElementById("statsOutput").innerText="Not numeric.";return;}
  nums.sort((a,b)=>a-b);
  let mean=nums.reduce((a,b)=>a+b,0)/nums.length;
  let median=nums.length%2?nums[(nums.length-1)/2]:((nums[nums.length/2-1]+nums[nums.length/2])/2);
  document.getElementById("statsOutput").innerHTML=`Mean: ${mean.toFixed(3)}<br>Median: ${median}<br>Min: ${nums[0]}<br>Max: ${nums.at(-1)}<br>Count: ${nums.length}`;
}

function detectAnomalies(){
  let col=document.getElementById("anomalyColumn").value;
  let method=document.getElementById("anomalyMethod").value;
  let nums=DATA.map(r=>parseFloat(r[col])).filter(v=>!isNaN(v));
  if(!nums.length){document.getElementById("anomalyOutput").innerText="Not numeric.";return;}
  ANOMALIES=[];
  if(method==="iqr"){
    nums.sort((a,b)=>a-b);
    let q1=nums[Math.floor(nums.length*.25)], q3=nums[Math.floor(nums.length*.75)];
    let low=q1-1.5*(q3-q1), high=q3+1.5*(q3-q1);
    ANOMALIES=DATA.filter(r=>{ let v=parseFloat(r[col]); return !isNaN(v) && (v<low||v>high); });
  } else {
    let mean=nums.reduce((a,b)=>a+b,0)/nums.length;
    let sd=Math.sqrt(nums.reduce((a,b)=>a+(b-mean)**2,0)/nums.length);
    ANOMALIES=DATA.filter(r=>{ let v=parseFloat(r[col]); return !isNaN(v) && Math.abs((v-mean)/sd)>2; });
  }
  document.getElementById("anomalyOutput").innerHTML=`Found <b>${ANOMALIES.length}</b> anomalies.`;
}

function exportAnomalies(){ if(!ANOMALIES.length){alert("Run detection first.");return;} downloadFile(Papa.unparse(ANOMALIES),"anomalies.csv"); }

function categoricalSummary(){
  let col=document.getElementById("catColumn").value; let c={};
  DATA.forEach(r=>{ let key = r[col]===undefined || r[col]===null ? '' : r[col]; c[key]=(c[key]||0)+1 });
  let out=""; Object.keys(c).forEach(k=>out+=`${escapeHtml(String(k))}: ${c[k]}<br>`);
  document.getElementById("catOutput").innerHTML=out;
}

function applyFilter(){
  let col=document.getElementById("filterColumn").value;
  let cond=document.getElementById("filterCondition").value;
  let val=document.getElementById("filterValue").value;
  if(cond==="contains"){
    let rows=DATA.filter(r=> String(r[col]).includes(val));
    previewTable(rows); document.getElementById("filterOutput").innerHTML=`Returned ${rows.length} rows.`; showingFull=true; document.getElementById('pageInfo').innerText='FILTERED'; return;
  }
  // numeric comparisons
  let numVal=parseFloat(val);
  let rows=DATA.filter(r=>{ let v=parseFloat(r[col]); if(isNaN(v) || isNaN(numVal)) return false; switch(cond){ case '==': return v==numVal; case '!=': return v!=numVal; case '>': return v>numVal; case '<': return v<numVal; case '>=': return v>=numVal; case '<=': return v<=numVal; default: return false; }});
  previewTable(rows); document.getElementById("filterOutput").innerHTML=`Returned ${rows.length} rows.`; showingFull=true; document.getElementById('pageInfo').innerText='FILTERED';
}

function runGroup(){
  let g=document.getElementById("groupBy1").value;
  let a=document.getElementById("groupAggCol").value;
  let f=document.getElementById("groupFunction").value;
  let groups={};
  DATA.forEach(r=>{let k=r[g]; if(!groups[k])groups[k]=[]; groups[k].push(parseFloat(r[a]));});
  let result=[];
  for(let k in groups){ let nums=groups[k].filter(v=>!isNaN(v));
    let val=f==="sum"?nums.reduce((a,b)=>a+b,0):f==="mean"?nums.reduce((a,b)=>a+b,0)/nums.length:nums.length;
    result.push({Group:k,Value:val});
  }
  let html=`<table><tr><th>Group</th><th>Value</th></tr>`;
  result.forEach(r=>html+=`<tr><td>${escapeHtml(String(r.Group))}</td><td>${r.Value}</td></tr>`);
  html+=`</table>`;
  document.getElementById("groupOutput").innerHTML=html;
}

/* ================= DATE-TIME ANALYSIS ================= */
function parseDate(d){ let dt=new Date(d); return isNaN(dt)?null:dt; }

function runDateAnalysis(){
  let col=document.getElementById("dateColumn").value;
  let op=document.getElementById("dateOperation").value;
  let dates=DATA.map(r=>parseDate(r[col])).filter(v=>v);
  if(!dates.length){document.getElementById("dateOutput").innerHTML="Not a valid date column.";return;}

  if(op==="minmax"){
    let min=new Date(Math.min(...dates));
    let max=new Date(Math.max(...dates));
    document.getElementById("dateOutput").innerHTML=`Earliest: ${min}<br>Latest: ${max}`;
    return;
  }

  let bucket={};
  dates.forEach(d=>{
    let key= op=="count_per_day"? d.toISOString().slice(0,10)
            : op=="count_per_month"? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`
            : `${d.getFullYear()}`;
    bucket[key]=(bucket[key]||0)+1;
  });

  let html="<table><tr><th>Period</th><th>Count</th></tr>";
  Object.keys(bucket).sort().forEach(k=>html+=`<tr><td>${k}</td><td>${bucket[k]}</td></tr>`);
  html+="</table>";
  document.getElementById("dateOutput").innerHTML=html;
}

function drawChart(){
  let type=document.getElementById("chartType").value;
  let x=document.getElementById("chartX").value;
  let y=document.getElementById("chartY").value;
  let labels=DATA.map(r=>r[x]);
  let values=DATA.map(r=>parseFloat(r[y]));
  if(chartInstance) chartInstance.destroy();
  let ctx=document.getElementById("myChart").getContext("2d");
  chartInstance=new Chart(ctx,{type,data:{labels,datasets:[{label:y,data:values,borderColor:"#ffb347",backgroundColor:"#ffb34755"}]},options:{responsive:true,scales:{x:{ticks:{color:"#ffdd99"}},y:{ticks:{color:"#ffdd99"}}}}});
}

function downloadFile(content,filename){ let a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([content])); a.download=filename; a.click(); }

function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;"); }
</script>
</body>
</html>
