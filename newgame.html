<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Number ‚Äî Polished</title>
  <meta name="description" content="Polished Guess the Number web game with improved UI, animations, accessibility and gameplay features." />
  <style>
    :root{
      --bg-1: linear-gradient(135deg,#0f172a 0%, #0b1220 100%);
      --glass: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.06);
      --muted: #94a3b8;
      --accent: #06b6d4;
      --accent-2: #7c3aed;
      --success: #22c55e;
      --danger: #ef4444;
      --max-width: 760px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color-scheme: dark;
    }
    html,body{height:100%}
    body{
      margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
      background:radial-gradient(1000px 500px at 10% 10%, rgba(124,58,237,0.12), transparent), radial-gradient(800px 400px at 90% 90%, rgba(6,182,212,0.08), transparent), #071025;
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .container{width:100%;max-width:var(--max-width);margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;flex-wrap:wrap}
    .title{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .select, .toggle, .btn, .icon-btn, .link-btn{background:var(--glass);border:1px solid var(--glass-border);padding:8px 10px;border-radius:10px;color:inherit;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .select select{background:transparent;border:0;color:inherit;font-weight:700;outline:none}
    main.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:16px;padding:18px;box-shadow:0 8px 36px rgba(2,6,23,0.6);backdrop-filter: blur(6px)}
    .grid{display:grid;grid-template-columns:1fr 260px;gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);background:transparent}
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    input[type=number]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:16px;outline:none;transition:transform .12s ease, box-shadow .12s ease;min-width:120px}
    input[type=number]:focus{box-shadow:0 6px 20px rgba(6,182,212,0.08);transform:translateY(-2px)}
    button.btn, .link-btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#071025;padding:10px 14px;border-radius:10px;font-weight:800;box-shadow:0 6px 18px rgba(7,161,173,0.12);transition:transform .12s ease}
    button.btn:hover, .link-btn:hover{transform:translateY(-3px) scale(1.01)}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:700}
    .log{min-height:74px;padding:12px;border-radius:10px;border:1px dashed rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(6,182,212,0.02), rgba(124,58,237,0.01));color:#e6eef8;display:flex;align-items:center;justify-content:center;text-align:center;position:relative;overflow:hidden}
    .emoji-popup{position:absolute;bottom:8px;font-size:44px;opacity:0;animation:bounceEmoji 2s ease-in-out infinite}
    @keyframes bounceEmoji{
      0%{transform:translateY(0);opacity:1}
      25%{transform:translateY(-18px)}
      50%{transform:translateY(0)}
      75%{transform:translateY(-10px)}
      100%{transform:translateY(0);opacity:1}
    }
    .meta{display:flex;flex-direction:column;gap:8px;margin-top:12px;color:var(--muted);font-size:14px}
    .scoreboard{display:flex;flex-direction:column;gap:12px}
    .score-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700}
    .score-label{color:var(--muted);font-weight:600}
    .progress-wrap{height:10px;background:rgba(255,255,255,0.02);border-radius:999px;overflow:hidden}
    .progress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width 0.15s linear}
    footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
    .visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <canvas id="confettiCanvas" aria-hidden="true"></canvas>

  <div class="container">
    <header>
      <div class="title">
        <h1>Guess the Number</h1>
        <div class="subtitle">Polished ‚Äî modern UI, animations & improved gameplay</div>
      </div>

      <div class="toolbar" role="toolbar" aria-label="Game controls">
        <div class="select" title="Difficulty">
          <label for="difficulty" class="visually-hidden">Difficulty</label>
          <select id="difficulty" aria-label="Select difficulty">
            <option value="easy">Easy (1‚Äì50)</option>
            <option value="normal" selected>Normal (1‚Äì100)</option>
            <option value="hard">Hard (1‚Äì500)</option>
          </select>
        </div>

        <button id="timerToggle" class="toggle" aria-pressed="false" title="Toggle timed rounds">‚è±Ô∏è Timed</button>
        <button id="soundToggle" class="toggle" aria-pressed="true" title="Toggle sounds">üîä</button>
        <button id="resetBest" class="icon-btn" title="Reset best scores">‚ôªÔ∏è</button>

        <a href="https://docs.google.com/document/d/1FRhtUlkFXN0YhrAdzL3LGeuumKVb1UFLXqfTIIZ48Fw/edit?usp=drivesdk" target="_blank" rel="noopener noreferrer" class="link-btn">üìÑ Proof Doc</a>
        <a href="https://binamg7.github.io/BG/game.html" target="_blank" rel="noopener noreferrer" class="link-btn">üéÆ Old Game</a>
      </div>
    </header>

    <main class="card" role="main">
      <div class="grid">
        <section aria-labelledby="gameLabel">
          <div class="panel">
            <h2 id="gameLabel">How to play</h2>
            <p class="subtitle">I'm thinking of a number in the selected range. Type your guess and press <strong>Guess</strong> or Enter/Done. Try to guess it in as few attempts as possible!</p>

            <div class="controls">
              <label for="guessInput" class="visually-hidden">Enter your guess</label>
              <input id="guessInput" type="number" inputmode="numeric" pattern="[0-9]*" min="1" placeholder="Enter a number" aria-label="Your guess" />
              <button id="guessBtn" class="btn" type="button">Guess</button>
              <button id="newRoundBtn" class="secondary" type="button">New Round</button>
            </div>

            <div id="log" class="log" aria-live="polite">Good luck ‚Äî make your first guess!</div>

            <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
              <div class="meta panel" style="flex:1;min-width:180px">
                <div>Range: <strong id="rangeLabel">1‚Äì100</strong></div>
                <div class="subtitle" style="color:var(--muted);font-size:13px">Tip: press Up/Down to adjust your guess quickly</div>
              </div>

              <div class="meta panel" style="flex:1;min-width:180px">
                <div>Attempts: <span id="attempts">0</span></div>
                <div>Streak: <span id="streak">0</span></div>
              </div>
            </div>

          </div>
        </section>

        <aside aria-labelledby="scoreLabel">
          <div class="panel scoreboard">
            <h3 id="scoreLabel">Scoreboard</h3>
            <div class="score-row"><div class="score-label">Best (per mode)</div><div class="score-value" id="best">‚Äî</div></div>
            <div class="score-row"><div class="score-label">Last Attempts</div><div class="score-value" id="lastAttempts">‚Äî</div></div>
            <div class="score-row"><div class="score-label">Mode</div><div class="score-value" id="modeLabel">Normal</div></div>

            <div style="margin-top:8px"><div class="score-label">Timer</div>
              <div class="progress-wrap" aria-hidden="true"><div id="progress" class="progress"></div></div>
              <div style="display:flex;justify-content:space-between;margin-top:6px"><small id="timeLabel" class="score-label">‚Äî</small><small class="score-label">Time left</small></div>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
              <button id="hintBtn" class="secondary" type="button">Give Hint</button>
              <button id="shareBtn" class="secondary" type="button">Share</button>
            </div>

            <footer style="margin-top:8px;color:var(--muted);font-size:12px">Settings & best scores persist using localStorage. Supports keyboard input (Enter to submit).</footer>
          </div>
        </aside>
      </div>

    </main>

    <footer>
      Built for portfolio ‚Äî polished UX, animations, and features.<br/>
      <a href="https://docs.google.com/document/d/1FRhtUlkFXN0YhrAdzL3LGeuumKVb1UFLXqfTIIZ48Fw/edit?usp=drivesdk" target="_blank" rel="noopener noreferrer">üìÑ Proof Document</a> ¬∑
      <a href="https://binamg7.github.io/BG/game.html" target="_blank" rel="noopener noreferrer">üéÆ Old Game</a>
    </footer>
  </div>

  <!-- Sound effects (hosted publicly) -->
  <audio id="soundWin" preload="auto">
    <source src="https://actions.google.com/sounds/v1/ambiences/crowd_cheer.ogg" type="audio/ogg">
  </audio>
  <audio id="soundLose" preload="auto">
    <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
  </audio>

  <script>
  (function(){
    'use strict';

    /* ----------------------
       Config & UI elements
       ---------------------- */
    const DIFFICULTIES = {
      easy: { max: 50, label: 'Easy (1‚Äì50)', time: 20 },
      normal: { max: 100, label: 'Normal (1‚Äì100)', time: 30 },
      hard: { max: 500, label: 'Hard (1‚Äì500)', time: 45 }
    };

    const UI = {
      guessInput: document.getElementById('guessInput'),
      guessBtn: document.getElementById('guessBtn'),
      newRoundBtn: document.getElementById('newRoundBtn'),
      log: document.getElementById('log'),
      attemptsEl: document.getElementById('attempts'),
      bestEl: document.getElementById('best'),
      lastAttemptsEl: document.getElementById('lastAttempts'),
      streakEl: document.getElementById('streak'),
      difficultySelect: document.getElementById('difficulty'),
      timerToggle: document.getElementById('timerToggle'),
      soundToggle: document.getElementById('soundToggle'),
      progress: document.getElementById('progress'),
      timeLabel: document.getElementById('timeLabel'),
      rangeLabel: document.getElementById('rangeLabel'),
      modeLabel: document.getElementById('modeLabel'),
      hintBtn: document.getElementById('hintBtn'),
      resetBestBtn: document.getElementById('resetBest'),
      shareBtn: document.getElementById('shareBtn'),
      confettiCanvas: document.getElementById('confettiCanvas'),
      container: document.querySelector('.card') || document.querySelector('main.card')
    };

    /* ----------------------
       Storage helper
       ---------------------- */
    const Storage = {
      get(key, fallback = null){
        try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; }
      },
      set(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
      },
      remove(key){
        try{ localStorage.removeItem(key); } catch(e) {}
      }
    };

    /* ----------------------
       Audio engine (WebAudio tones + playback control)
       ---------------------- */
    const AudioEngine = (function(){
      let ctx = null;
      function ensure(){
        if(!ctx){
          ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
      }
      function resume(){
        if(ctx && ctx.state === 'suspended') return ctx.resume();
        return Promise.resolve();
      }
      function playTone(freq=440, dur=0.12, type='sine', vol=0.08){
        try{
          ensure();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = type; o.frequency.value = freq;
          g.gain.value = vol;
          o.connect(g); g.connect(ctx.destination);
          o.start();
          g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
          o.stop(ctx.currentTime + dur + 0.02);
        }catch(e){}
      }
      function playSequence(notes, tempo=1){
        try{
          ensure();
          let t = ctx.currentTime;
          notes.forEach(n=>{
            const [f,d] = n;
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'sine'; o.frequency.value = f;
            g.gain.value = 0.08;
            o.connect(g); g.connect(ctx.destination);
            o.start(t);
            g.gain.exponentialRampToValueAtTime(0.0001, t + d);
            o.stop(t + d + 0.02);
            t += d * tempo;
          });
        }catch(e){}
      }
      return { ensure, resume, playTone, playSequence };
    })();

    /* ----------------------
       Confetti engine
       ---------------------- */
    function Confetti(canvas){
      this.canvas = canvas;
      this.ctx = canvas.getContext('2d');
      this.particles = [];
      this.running = false;
      this.h = canvas.height = window.innerHeight;
      this.w = canvas.width = window.innerWidth;
      this.colors = ['#06b6d4','#7c3aed','#f97316','#f43f5e','#22c55e','#eab308'];
      window.addEventListener('resize', ()=>{ this.h = canvas.height = window.innerHeight; this.w = canvas.width = window.innerWidth; });
    }
    Confetti.prototype.launch = function(count = 60){
      for(let i=0;i<count;i++){
        this.particles.push({
          x: Math.random()*this.w,
          y: -20 - Math.random()*200,
          vx:(Math.random()-0.5)*4,
          vy:Math.random()*3+2,
          size:Math.random()*8+4,
          color: this.colors[(Math.random()*this.colors.length)|0],
          rot: Math.random()*360,
          vr: (Math.random()-0.5)*10
        });
      }
      if(!this.running){ this.running = true; this._tick(); }
    };
    Confetti.prototype._tick = function(){
      if(!this.running) return;
      const ctx = this.ctx;
      ctx.clearRect(0,0,this.w,this.h);
      for(let i=this.particles.length-1;i>=0;i--){
        const p = this.particles[i];
        p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.rot += p.vr;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot * Math.PI/180);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
        ctx.restore();
        if(p.y > this.h + 50) this.particles.splice(i,1);
      }
      if(this.particles.length > 0){ requestAnimationFrame(()=>this._tick()); }
      else { this.running = false; ctx.clearRect(0,0,this.w,this.h); }
    };

    /* ----------------------
       Game class
       ---------------------- */
    class Game {
      constructor(){
        // load settings
        this.mode = Storage.get('g_mode', 'normal');
        this.timed = Storage.get('g_timed', false);
        this.sounds = Storage.get('g_sounds', true);

        // state
        this.target = null;
        this.attempts = 0;
        this.best = Storage.get('g_best', {}); // object per mode
        this.streak = Storage.get('g_streak', 0);
        this.timerId = null;
        this.timeStart = 0;
        this.timeLeft = 0;

        this.confetti = new Confetti(UI.confettiCanvas);

        this._bindUI();
        this._applySettings();
        this.newRound(true);

        // ensure audio context is resumed on first gesture
        const resumeAudioOnce = ()=>{ AudioEngine.ensure(); AudioEngine.resume(); window.removeEventListener('pointerdown', resumeAudioOnce); window.removeEventListener('touchstart', resumeAudioOnce); window.removeEventListener('keydown', resumeAudioOnce); };
        window.addEventListener('pointerdown', resumeAudioOnce);
        window.addEventListener('touchstart', resumeAudioOnce);
        window.addEventListener('keydown', resumeAudioOnce);
      }

      _bindUI(){
        UI.guessBtn.addEventListener('click', ()=>this.handleGuess());
        UI.newRoundBtn.addEventListener('click', ()=>this.newRound(false));
        UI.guessInput.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === 'Done') { e.preventDefault(); this.handleGuess(); return; }
          if(e.key === 'ArrowUp'){ e.preventDefault(); UI.guessInput.stepUp(); }
          if(e.key === 'ArrowDown'){ e.preventDefault(); UI.guessInput.stepDown(); }
        });

        UI.difficultySelect.value = this.mode;
        UI.difficultySelect.addEventListener('change', (e)=>{ this.mode = e.target.value; Storage.set('g_mode', this.mode); this.newRound(true); });

        UI.timerToggle.addEventListener('click', ()=>{ this.timed = !this.timed; Storage.set('g_timed', this.timed); UI.timerToggle.setAttribute('aria-pressed', String(this.timed)); this.newRound(true); });
        UI.soundToggle.addEventListener('click', ()=>{ this.sounds = !this.sounds; Storage.set('g_sounds', this.sounds); UI.soundToggle.setAttribute('aria-pressed', String(this.sounds)); });
        UI.hintBtn.addEventListener('click', ()=>this.showHint());
        UI.resetBestBtn.addEventListener('click', ()=>{ if(confirm('Reset all best scores and streak?')){ this.best = {}; this.streak = 0; Storage.set('g_best', this.best); Storage.set('g_streak', this.streak); this.updateScoreboard(); this.announce('Best scores reset.'); }});
        UI.shareBtn.addEventListener('click', ()=>this.shareResult());
      }

      _applySettings(){
        UI.difficultySelect.value = this.mode;
        UI.timerToggle.setAttribute('aria-pressed', String(this.timed));
        UI.soundToggle.setAttribute('aria-pressed', String(this.sounds));
        UI.modeLabel.textContent = DIFFICULTIES[this.mode].label.split(' ')[0];
        this.updateScoreboard();
      }

      newRound(silent=false){
        const cfg = DIFFICULTIES[this.mode];
        this.rangeMin = 1;
        this.rangeMax = cfg.max;
        this.target = Math.floor(Math.random() * (this.rangeMax - this.rangeMin + 1)) + this.rangeMin;
        this.attempts = 0;
        this.timeLeft = this.timed ? cfg.time : 0;
        this._clearTimer();
        if(this.timed) this._startTimer();

        // UI
        UI.rangeLabel.textContent = `${this.rangeMin}‚Äì${this.rangeMax}`;
        UI.attemptsEl.textContent = this.attempts;
        UI.guessInput.value = '';
        UI.guessInput.placeholder = `1 ‚Äî ${this.rangeMax}`;
        UI.guessInput.disabled = false; UI.guessBtn.disabled = false;
        UI.log.textContent = `New round started. Guess a number between ${this.rangeMin} and ${this.rangeMax}.`;

        if(!silent){ UI.container.classList.remove('shake'); UI.container.classList.add('flash'); setTimeout(()=>UI.container.classList.remove('flash'),700); }
        UI.guessInput.focus();
      }

      handleGuess(){
        // Ensure input parsed correctly on mobile (some keyboards insert non-digit)
        const raw = UI.guessInput.value.toString().trim();
        const val = Number(raw);
        if(!Number.isInteger(val) || val < this.rangeMin || val > this.rangeMax){
          this._announceWarning(`Please enter a whole number between ${this.rangeMin} and ${this.rangeMax}.`);
          UI.guessInput.focus();
          return;
        }

        this.attempts += 1; UI.attemptsEl.textContent = this.attempts;

        if(val === this.target) this._win();
        else if(val < this.target) this._feedback('low');
        else this._feedback('high');

        UI.guessInput.select();
      }

      _feedback(type){
        if(type === 'low'){
          this.announce('Too low. Try a higher number.');
          UI.log.innerHTML = `<span style="font-weight:800;color:var(--muted)">Too low.</span> Try a higher number.`;
          this._animShake(false);
          this._emojiEvent('üò≠','lose');
          if(this.sounds) AudioEngine.playTone(220,0.08);
        } else {
          this.announce('Too high. Try a lower number.');
          UI.log.innerHTML = `<span style="font-weight:800;color:var(--muted)">Too high.</span> Try a lower number.`;
          this._animShake(false);
          this._emojiEvent('üò≠','lose');
          if(this.sounds) AudioEngine.playTone(160,0.08);
        }
      }

      _win(){
        this._clearTimer();
        UI.log.innerHTML = `<span style="font-weight:900;color:var(--success)">üéâ Correct! The number was ${this.target}.</span> You guessed it in <strong>${this.attempts}</strong> attempts.`;
        UI.guessInput.disabled = true; UI.guessBtn.disabled = true;
        this._updateBest(this.attempts);
        this.lastAttempts = this.attempts; UI.lastAttemptsEl.textContent = this.attempts;
        this.streak = (this.streak || 0) + 1; Storage.set('g_streak', this.streak); UI.streakEl.textContent = this.streak;

        if(this.sounds){
          // short cheer sequence with WebAudio and audio file
          AudioEngine.playSequence([[880,0.08],[660,0.08],[990,0.16]],0.9);
          const audio = document.getElementById('soundWin');
          if(audio){ audio.currentTime = 0; audio.play().catch(()=>{}); }
        }
        this.confetti.launch(90);
        UI.container.classList.add('flash'); setTimeout(()=>UI.container.classList.remove('flash'),900);

        this._emojiEvent('üì£üë©‚Äçüé§','win');

        setTimeout(()=>{ UI.newRoundBtn.focus(); }, 400);
      }

      _lose(reason){
        this._clearTimer();
        UI.log.innerHTML = `<span style="font-weight:900;color:var(--danger)">${reason}</span>`;
        UI.guessInput.disabled = true; UI.guessBtn.disabled = true;
        this.streak = 0; Storage.set('g_streak', this.streak); UI.streakEl.textContent = this.streak;
        if(this.sounds){
          AudioEngine.playTone(120,0.4,'sawtooth',0.12);
          const audio = document.getElementById('soundLose');
          if(audio){ audio.currentTime = 0; audio.play().catch(()=>{}); }
        }
        UI.container.classList.add('shake'); setTimeout(()=>UI.container.classList.remove('shake'),700);
        this._emojiEvent('üò≠','lose');
      }

      showHint(){
        const mid = Math.round((this.rangeMin + this.rangeMax)/2);
        const distance = Math.abs((UI.guessInput.value ? Number(UI.guessInput.value) : mid) - this.target);
        let proximity = 'far';
        if(distance <= Math.max(3, Math.round((this.rangeMax - this.rangeMin)/15))) proximity = 'very close';
        else if(distance <= Math.max(8, Math.round((this.rangeMax - this.rangeMin)/8))) proximity = 'close';
        const half = this.target <= mid ? 'lower' : 'upper';
        const msg = `Hint: The number is in the ${half} half and you are ${proximity}.`;
        this.announce(msg);
        UI.log.innerHTML = `<strong>üí° Hint:</strong> ${msg}`;
        if(this.sounds) AudioEngine.playTone(520,0.12);
      }

      _startTimer(){
        const cfg = DIFFICULTIES[this.mode];
        this.timeLeft = cfg.time;
        UI.timeLabel.textContent = `${this.timeLeft}s`;
        UI.progress.style.width = '100%';
        const start = performance.now();
        const duration = cfg.time * 1000;
        const step = (ts)=>{
          const elapsed = ts - start;
          const pct = Math.max(0, 1 - elapsed/duration);
          UI.progress.style.width = `${Math.round(pct*100)}%`;
          UI.timeLabel.textContent = `${Math.ceil((pct*duration)/1000)}s`;
          if(pct <= 0){ this._lose('‚è±Ô∏è Time is up! You lost this round.'); return; }
          this.timerId = requestAnimationFrame(step);
        };
        this.timerId = requestAnimationFrame(step);
      }

      _clearTimer(){ if(this.timerId){ cancelAnimationFrame(this.timerId); this.timerId = null; UI.progress.style.width='0%'; UI.timeLabel.textContent='‚Äî'; } }

      _updateBest(attempts){
        const key = this.mode;
        const prev = this.best[key];
        if(!prev || attempts < prev){
          this.best[key] = attempts; Storage.set('g_best', this.best);
          UI.bestEl.textContent = attempts;
          this.announce(`New best for ${this.mode}: ${attempts} attempts.`);
        }
        this.updateScoreboard();
      }

      updateScoreboard(){
        UI.bestEl.textContent = this.best[this.mode] || '‚Äî';
        UI.modeLabel.textContent = DIFFICULTIES[this.mode].label.split(' ')[0];
        UI.streakEl.textContent = this.streak || 0;
        UI.lastAttemptsEl.textContent = this.lastAttempts || '‚Äî';
      }

      announce(text){ UI.log.textContent = text; }
      _announceWarning(text){ UI.log.innerHTML = `‚ö†Ô∏è ${text}`; if(this.sounds) AudioEngine.playTone(180,0.12); }

      _animShake(){ UI.container.classList.add('shake'); setTimeout(()=>UI.container.classList.remove('shake'),600); }

      shareResult(){
        const msg = `I guessed the number in ${this.lastAttempts || '‚Äî'} attempts on ${DIFFICULTIES[this.mode].label}! Can you beat me?`;
        if(navigator.share){ navigator.share({title:'Guess the Number', text: msg}).catch(()=>{}); }
        else { navigator.clipboard.writeText(msg).then(()=>{ alert('Result copied to clipboard'); }).catch(()=>{ alert(msg); }); }
      }

      _emojiEvent(emoji, soundKey){
        // show bouncing emoji for a short duration, play small audio if allowed
        showEmoji(emoji, soundKey, this.sounds);
      }
    } // end Game

    /* ----------------------
       Emoji popup + audio helper
       ---------------------- */
    function showEmoji(emoji, soundKey='win', allowed=true){
      const log = document.getElementById('log');
      const span = document.createElement('span');
      span.textContent = emoji;
      span.className = 'emoji-popup';
      // if multiple popups exist, slightly offset horizontally to avoid overlap
      const existing = log.querySelectorAll('.emoji-popup').length;
      span.style.left = `${8 + existing*36}px`;
      log.appendChild(span);
      // play small audio (we use HTML audio elements for larger sounds, and WebAudio for short tones)
      if(allowed){
        if(soundKey === 'win'){
          const audio = document.getElementById('soundWin');
          if(audio){ audio.currentTime = 0; audio.play().catch(()=>{}); }
          // add a small WebAudio jingle
          AudioEngine.playSequence([[880,0.08],[660,0.08],[990,0.12]],0.8);
        } else {
          const audio = document.getElementById('soundLose');
          if(audio){ audio.currentTime = 0; audio.play().catch(()=>{}); }
          AudioEngine.playTone(220,0.18,'sawtooth',0.08);
        }
      }
      // remove after 4 seconds
      setTimeout(()=>{ span.remove(); }, 4000);
    }

    /* ----------------------
       Instantiate game and expose for debug
       ---------------------- */
    // Wait for DOM fully ready
    window.addEventListener('DOMContentLoaded', ()=>{
      // create and store game instance on window so later code can hook if needed
      window.__game = new Game();
      // expose confetti for debug
      window.__confetti = window.__game.confetti;
    });
  })();
  </script>
</body>
</html>
